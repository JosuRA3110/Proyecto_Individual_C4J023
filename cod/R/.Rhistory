datos_estado <- datos_grafico %>% filter(state == st)
if(nrow(datos_estado) > 0){
p <- ggplot(datos_estado, aes(x = Obesidad, y = Cardiovascular)) +
geom_point(color = "red") +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
labs(
title = paste("Obesidad vs Enfermedades Cardiovasculares -", st),
x = "Obesidad (%)",
y = "Enfermedades Cardiovasculares (%)"
)
ggsave(
filename = file.path(carpeta_estado, paste0(st, "_obesidad_vs_cardiovascular.png")),
plot = p,
width = 7,
height = 5
)
}
}
library(tidyverse)
library(dplyr)
library(here)
library(janitor)
# --- Cargar y limpiar bases ---
obesidad <- read_csv(here("data_raw/Obesidad.csv")) %>%
clean_names() %>%
select(year, state, rate) %>%
mutate(
year = as.integer(year),
state = str_trim(tolower(as.character(state))),
rate = as.numeric(rate)
)
mortalidad <- read_csv(here("data_raw/Mortalidad_cardiovascular.csv")) %>%
clean_names() %>%
filter(geographic_level == "State") %>%
select(
year,
state = location_desc,
data_value
) %>%
mutate(
year = as.integer(year),
state = str_trim(tolower(as.character(state))),
data_value = as.numeric(data_value)
) %>%
group_by(state) %>%
mutate(
data_value = ifelse(is.na(data_value), mean(data_value, na.rm = TRUE), data_value)
) %>%
ungroup()
# --- Combinar por state y year ---
obesidad_mortalidad <- left_join(
obesidad,
mortalidad,
by = c("state", "year")
)
# Revisar NAs
sum(is.na(obesidad_mortalidad$data_value))  # debe ser 0
# --- Preparar datos para gráficos ---
datos_grafico <- obesidad_mortalidad %>%
filter(!is.na(data_value)) %>%
select(state, year, Obesidad = rate, Cardiovascular = data_value)
# --- Crear gráficos por estado ---
estados_unicos <- unique(datos_grafico$state)
for (st in estados_unicos) {
carpeta_estado <- file.path("res", st)
if(!dir.exists(carpeta_estado)) dir.create(carpeta_estado, recursive = TRUE)
datos_estado <- datos_grafico %>% filter(state == st)
if(nrow(datos_estado) > 0){
p <- ggplot(datos_estado, aes(x = Obesidad, y = Cardiovascular)) +
geom_point(color = "red") +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
labs(
title = paste("Obesidad vs Enfermedades Cardiovasculares -", st),
x = "Obesidad (%)",
y = "Enfermedades Cardiovasculares (%)"
)
ggsave(
filename = file.path(carpeta_estado, paste0(st, "_obesidad_vs_cardiovascular.png")),
plot = p,
width = 7,
height = 5
)
}
}
library(tidyverse)
library(here)
library(janitor)
# --- Cargar y limpiar obesidad ---
obesidad <- read_csv(here("data_raw/Obesidad.csv"), show_col_types = FALSE) %>%
clean_names() %>%
select(year, state = state, rate) %>%
mutate(
year = as.integer(year),
state = str_trim(tolower(as.character(state))),
rate = as.numeric(rate)
)
# --- Cargar y limpiar mortalidad ---
mortalidad <- read_csv(here("data_raw/Mortalidad_cardiovascular.csv"), show_col_types = FALSE) %>%
clean_names() %>%
filter(geographic_level == "State") %>%
select(
year,
state = location_desc,
data_value
) %>%
mutate(
year = as.integer(year),
state = str_trim(tolower(as.character(state))),
data_value = as.numeric(data_value)
) %>%
group_by(state) %>%
mutate(
data_value = ifelse(is.na(data_value), mean(data_value, na.rm = TRUE), data_value)
) %>%
ungroup()
# --- Combinar por state y year ---
obesidad_mortalidad <- left_join(
obesidad,
mortalidad,
by = c("state", "year")
)
# Verificar NAs
sum(is.na(obesidad_mortalidad$data_value))  # debe ser 0
# --- Preparar datos para gráficos ---
datos_grafico <- obesidad_mortalidad %>%
filter(!is.na(data_value)) %>%
select(state, year, Obesidad = rate, Cardiovascular = data_value)
# --- Crear gráficos por estado ---
estados_unicos <- unique(datos_grafico$state)
for (st in estados_unicos) {
carpeta_estado <- file.path("res", st)
if(!dir.exists(carpeta_estado)) dir.create(carpeta_estado, recursive = TRUE)
datos_estado <- datos_grafico %>% filter(state == st)
if(nrow(datos_estado) > 0){
p <- ggplot(datos_estado, aes(x = Obesidad, y = Cardiovascular)) +
geom_point(color = "red") +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
labs(
title = paste("Obesidad vs Enfermedades Cardiovasculares -", str_to_title(st)),
x = "Obesidad (%)",
y = "Enfermedades Cardiovasculares (%)"
)
ggsave(
filename = file.path(carpeta_estado, paste0(str_replace_all(str_to_title(st), " ", "_"), "_obesidad_vs_cardiovascular.png")),
plot = p,
width = 7,
height = 5
)
}
}
View(obesidad_mortalidad)
View(obesidad_limpia)
View(obesidad_mortalidad)
sort(unique(obesidad$year))
sort(unique(mortalidad$year))
library(tidyverse)
library(here)
library(janitor)
# --- Cargar y limpiar obesidad ---
obesidad <- read_csv(here("data_raw/Obesidad.csv"), show_col_types = FALSE) %>%
clean_names() %>%
select(year, state = state, rate) %>%
mutate(
year = as.integer(year),
state = str_trim(tolower(as.character(state))),
rate = as.numeric(rate)
)
# --- Cargar y limpiar mortalidad ---
mortalidad <- read_csv(here("data_raw/Mortalidad_cardiovascular.csv"), show_col_types = FALSE) %>%
clean_names() %>%
filter(geographic_level == "State") %>%
select(year, state = location_desc, data_value) %>%
mutate(
year = as.integer(year),
state = str_trim(tolower(as.character(state))),
data_value = as.numeric(data_value)
)
# --- Detectar año(s) común(es) ---
años_comunes <- intersect(obesidad$year, mortalidad$year)
print(paste("Año(s) común(es):", paste(años_comunes, collapse = ", ")))
# --- Filtrar solo años comunes ---
obesidad_filtrada <- obesidad %>% filter(year %in% años_comunes)
mortalidad_filtrada <- mortalidad %>% filter(year %in% años_comunes)
# --- Combinar por state (ya mismo todos los años son iguales) ---
obesidad_mortalidad <- left_join(
obesidad_filtrada,
mortalidad_filtrada,
by = c("state", "year")
)
# --- Revisar NAs ---
na_count <- sum(is.na(obesidad_mortalidad$data_value))
print(paste("Cantidad de NAs en data_value:", na_count))
# Si hay NA en data_value, imputar por promedio del estado
if(na_count > 0){
obesidad_mortalidad <- obesidad_mortalidad %>%
group_by(state) %>%
mutate(
data_value = ifelse(is.na(data_value), mean(data_value, na.rm = TRUE), data_value)
) %>%
ungroup()
}
# --- Preparar datos para gráficos ---
datos_grafico <- obesidad_mortalidad %>%
filter(!is.na(data_value)) %>%
select(state, Obesidad = rate, Cardiovascular = data_value)
# --- Crear carpeta principal 'res' ---
if(!dir.exists("res")) dir.create("res")
# --- Crear gráficos por estado ---
estados_unicos <- unique(datos_grafico$state)
for (st in estados_unicos) {
carpeta_estado <- file.path("res", st)
if(!dir.exists(carpeta_estado)) dir.create(carpeta_estado, recursive = TRUE)
datos_estado <- datos_grafico %>% filter(state == st)
if(nrow(datos_estado) > 0){
p <- ggplot(datos_estado, aes(x = Obesidad, y = Cardiovascular)) +
geom_point(color = "red") +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
labs(
title = paste("Obesidad vs Enfermedades Cardiovasculares -", str_to_title(st)),
x = "Obesidad (%)",
y = "Enfermedades Cardiovasculares (%)"
)
ggsave(
filename = file.path(carpeta_estado, paste0(str_replace_all(str_to_title(st), " ", "_"), "_obesidad_vs_cardiovascular.png")),
plot = p,
width = 7,
height = 5
)
}
}
# --- Guardar CSV final combinado ---
write_csv(obesidad_mortalidad, here("data/Obesidad_Mortalidad_2019.csv"))
View(datos_estado)
View(datos_estado)
View(datos_grafico)
library(tidyverse)
library(here)
library(janitor)
# --- Cargar y limpiar obesidad ---
obesidad <- read_csv(here("data_raw/Obesidad.csv"), show_col_types = FALSE) %>%
clean_names() %>%
select(year, state = state, rate) %>%
mutate(
year = as.integer(year),
state = str_to_title(str_trim(state)), # nombres estandarizados
rate = as.numeric(rate)
)
# --- Cargar y limpiar mortalidad ---
mortalidad <- read_csv(here("data_raw/Mortalidad_cardiovascular.csv"), show_col_types = FALSE) %>%
clean_names() %>%
filter(geographic_level == "State") %>%
select(year, state = location_desc, data_value) %>%
mutate(
year = as.integer(year),
state = str_to_title(str_trim(state)), # nombres estandarizados
data_value = as.numeric(data_value)
)
# --- Detectar año(s) común(es) ---
años_comunes <- intersect(obesidad$year, mortalidad$year)
print(paste("Año(s) común(es):", paste(años_comunes, collapse = ", ")))
# --- Filtrar solo años comunes ---
obesidad_filtrada <- obesidad %>% filter(year %in% años_comunes)
mortalidad_filtrada <- mortalidad %>% filter(year %in% años_comunes)
# --- Combinar por state y year ---
obesidad_mortalidad <- left_join(
obesidad_filtrada,
mortalidad_filtrada,
by = c("state", "year")
)
# --- Imputar NA si existe ---
if(sum(is.na(obesidad_mortalidad$data_value)) > 0){
obesidad_mortalidad <- obesidad_mortalidad %>%
group_by(state) %>%
mutate(data_value = ifelse(is.na(data_value), mean(data_value, na.rm = TRUE), data_value)) %>%
ungroup()
}
# --- Preparar datos para gráficos ---
datos_grafico <- obesidad_mortalidad %>%
filter(!is.na(data_value)) %>%
select(state, Obesidad = rate, Cardiovascular = data_value)
# --- Crear carpeta principal 'res' ---
if(!dir.exists("res")) dir.create("res")
# --- Crear gráficos por estado ---
estados_unicos <- unique(datos_grafico$state)
for (st in estados_unicos) {
carpeta_estado <- file.path("res", st)
if(!dir.exists(carpeta_estado)) dir.create(carpeta_estado, recursive = TRUE)
datos_estado <- datos_grafico %>% filter(state == st)
p <- ggplot(datos_estado, aes(x = Obesidad, y = Cardiovascular)) +
geom_point(color = "red") +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
labs(
title = paste("Obesidad vs Enfermedades Cardiovasculares -", st),
x = "Obesidad (%)",
y = "Enfermedades Cardiovasculares (%)"
)
ggsave(
filename = file.path(carpeta_estado, paste0(str_replace_all(st, " ", "_"), "_obesidad_vs_cardiovascular.png")),
plot = p,
width = 7,
height = 5
)
}
# --- Guardar CSV final ---
write_csv(obesidad_mortalidad, here("data/Obesidad_Mortalidad_2019.csv"))
sum(is.na(obesidad_mortalidad$data_value))
length(unique(datos_grafico$state))
library(shiny)
install.packages("shiny")
install.packages("maps")
library(shiny)
library(tidyverse)
library(plotly)
install.packages("ploty")
library(shiny)
library(tidyverse)
library(plotly)
install.packages("plotly")
library(shiny)
library(tidyverse)
library(plotly)
library(maps)
library(janitor)
# --- Cargar y limpiar obesidad y mortalidad ---
obesidad <- read_csv("data_raw/Obesidad.csv", show_col_types = FALSE) %>%
clean_names() %>%
select(year, state = state, rate) %>%
mutate(
year = as.integer(year),
state = str_to_title(str_trim(state)),
rate = as.numeric(rate)
)
library(shiny)
library(tidyverse)
library(plotly)
library(maps)
library(janitor)
library(here)
# --- Cargar y limpiar obesidad y mortalidad ---
obesidad <- read_csv(here("data_raw/Obesidad.csv"), show_col_types = FALSE) %>%
clean_names() %>%
select(year, state = state, rate) %>%
mutate(
year = as.integer(year),
state = str_to_title(str_trim(state)),
rate = as.numeric(rate)
)
mortalidad <- read_csv(here("data_raw/Mortalidad_cardiovascular.csv"), show_col_types = FALSE) %>%
clean_names() %>%
filter(geographic_level == "State") %>%
select(year, state = location_desc, data_value) %>%
mutate(
year = as.integer(year),
state = str_to_title(str_trim(state)),
data_value = as.numeric(data_value)
)
# --- Filtrar solo años comunes ---
años_comunes <- intersect(obesidad$year, mortalidad$year)
obesidad <- obesidad %>% filter(year %in% años_comunes)
mortalidad <- mortalidad %>% filter(year %in% años_comunes)
# --- Combinar bases y crear carpeta res ---
obesidad_mortalidad <- left_join(obesidad, mortalidad, by = c("state", "year")) %>%
group_by(state) %>%
mutate(data_value = ifelse(is.na(data_value), mean(data_value, na.rm = TRUE), data_value)) %>%
ungroup() %>%
filter(!is.na(data_value))
# --- Preparar carpeta res y guardar gráficos ---
if(!dir.exists(here("res"))) dir.create(here("res"))
estados_unicos <- unique(obesidad_mortalidad$state)
for(st in estados_unicos){
carpeta_estado <- here("res", st)
if(!dir.exists(carpeta_estado)) dir.create(carpeta_estado)
datos_estado <- obesidad_mortalidad %>% filter(state == st)
p <- ggplot(datos_estado, aes(x = rate, y = data_value)) +
geom_point(color = "red") +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
labs(
title = paste("Obesidad vs Enfermedades Cardiovasculares -", st),
x = "Obesidad (%)",
y = "Enfermedades Cardiovasculares (%)"
)
ggsave(
filename = file.path(carpeta_estado, paste0(st, "_obesidad_vs_cardiovascular.png")),
plot = p,
width = 7, height = 5
)
}
# --- Datos de mapa de EE.UU ---
us_states <- map_data("state") %>%
mutate(region = str_to_title(region))
# --- Shiny UI ---
ui <- fluidPage(
titlePanel("Mapa interactivo de Estados Unidos: Obesidad vs Enfermedades Cardiovasculares"),
sidebarLayout(
sidebarPanel(
p("Haz clic en un estado para ver su gráfico.")
),
mainPanel(
plotlyOutput("mapa"),
uiOutput("grafico_estado")
)
)
)
# --- Shiny Server ---
server <- function(input, output, session){
# Mapa interactivo con plotly
output$mapa <- renderPlotly({
gg <- ggplot(us_states, aes(long, lat, group = group, text = region)) +
geom_polygon(fill = "lightblue", color = "white") +
coord_fixed(1.3) +
theme_void()
ggplotly(gg, tooltip = "text") %>%
event_register("plotly_click")
})
# Detectar clic y mostrar gráfico
output$grafico_estado <- renderUI({
d <- event_data("plotly_click")
if(is.null(d)) return(NULL)
estado_seleccionado <- d$text
grafico_path <- list.files(path = here("res", estado_seleccionado),
pattern = "_obesidad_vs_cardiovascular.png$", full.names = TRUE)
if(length(grafico_path) == 0) return(NULL)
tags$img(src = grafico_path, width = "700px")
})
}
# --- Run App ---
shinyApp(ui, server)
library(shiny)
library(tidyverse)
library(plotly)
library(maps)
library(janitor)
library(here)
obesidad <- read_csv(here("data_raw/Obesidad.csv"), show_col_types = FALSE) %>%
clean_names() %>%
select(year, state = state, rate) %>%
mutate(
year = as.integer(year),
state = str_to_title(str_trim(state)),
rate = as.numeric(rate)
)
mortalidad <- read_csv(here("data_raw/Mortalidad_cardiovascular.csv"), show_col_types = FALSE) %>%
clean_names() %>%
filter(geographic_level == "State") %>%
select(year, state = location_desc, data_value) %>%
mutate(
year = as.integer(year),
state = str_to_title(str_trim(state)),
data_value = as.numeric(data_value)
)
años_comunes <- intersect(obesidad$year, mortalidad$year)
obesidad <- obesidad %>% filter(year %in% años_comunes)
mortalidad <- mortalidad %>% filter(year %in% años_comunes)
obesidad_mortalidad <- left_join(obesidad, mortalidad, by = c("state", "year")) %>%
group_by(state) %>%
mutate(data_value = ifelse(is.na(data_value), mean(data_value, na.rm = TRUE), data_value)) %>%
ungroup() %>%
filter(!is.na(data_value))
if(!dir.exists(here("res"))) dir.create(here("res"))
estados_unicos <- unique(obesidad_mortalidad$state)
for(st in estados_unicos){
carpeta_estado <- here("res", st)
if(!dir.exists(carpeta_estado)) dir.create(carpeta_estado)
datos_estado <- obesidad_mortalidad %>% filter(state == st)
p <- ggplot(datos_estado, aes(x = rate, y = data_value)) +
geom_point(color = "red") +
geom_smooth(method = "lm", se = FALSE, color = "blue") +
labs(
title = paste("Obesidad vs Enfermedades Cardiovasculares -", st),
x = "Obesidad (%)",
y = "Enfermedades Cardiovasculares (%)"
)
ggsave(
filename = file.path(carpeta_estado, paste0(st, "_obesidad_vs_cardiovascular.png")),
plot = p,
width = 7, height = 5
)
}
us_states <- map_data("state") %>%
mutate(region = str_to_title(region))
ui <- fluidPage(
titlePanel("Mapa interactivo de Estados Unidos: Obesidad vs Enfermedades Cardiovasculares"),
sidebarLayout(
sidebarPanel(
p("Haz clic en un estado para ver su gráfico.")
),
mainPanel(
plotlyOutput("mapa"),
uiOutput("grafico_estado")
)
)
)
server <- function(input, output, session){
output$mapa <- renderPlotly({
gg <- ggplot(us_states, aes(long, lat, group = group, text = region)) +
geom_polygon(fill = "lightblue", color = "white") +
coord_fixed(1.3) +
theme_void()
ggplotly(gg, tooltip = "text") %>%
event_register("plotly_click")
})
output$grafico_estado <- renderUI({
d <- event_data("plotly_click")
if(is.null(d)) return(NULL)
estado_seleccionado <- d$text
grafico_path <- list.files(path = here("res", estado_seleccionado),
pattern = "_obesidad_vs_cardiovascular.png$", full.names = TRUE)
if(length(grafico_path) == 0) return(NULL)
tags$img(src = grafico_path, width = "700px")
})
}
shinyApp(ui, server)
